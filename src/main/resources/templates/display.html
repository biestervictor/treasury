<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Displays</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .hidden { display: none; }
        tr.clickable-row { cursor: pointer; }
    </style>
</head>
<body class="bg-light">
<nav th:replace="navbarDisplay.html :: nav"></nav>
<div th:replace="addDisplay.html :: addForm"></div>

<div class="mb-3">
    <button class="btn btn-secondary" onclick="toggleIdColumn()">ID-Spalte ein-/ausblenden</button>
</div>
<div class="mb-3">
    <strong>Summe Einkaufspreise:</strong>
    <span th:text="${sumEinkaufspreis} + ' €'"></span>
    &nbsp; | &nbsp;
    <strong>Summe Aktueller Preise:</strong>
    <span th:text="${sumAktuellerPreis} + ' €'"></span>
    &nbsp; | &nbsp;
    <strong>Gewinn bei Verkäufen:</strong>
    <span th:text="${sumGewinn} + ' €'"></span>
</div>

<form id="tableFilterForm" action="/api/display/list" method="get">
    <input type="hidden" id="soldOnly" name="soldOnly" th:value="${soldOnly} ? 'true' : 'false'" />
</form>
<table class="table table-striped table-hover" data-sort-order="asc" id="displayTable">
    <thead class="table-dark">
    <tr>
        <th class="id-column hidden">ID</th>
        <th onclick="sortTable(1)">Set Code &#x25B2;&#x25BC;</th>
        <th>Icon</th>
        <th>Typ</th>
        <th>Name</th>
        <th>Einkaufspreis</th>
        <th>Aktueller Wert</th>
        <th>Lagerort</th>
        <th>Zuletzt aktualisiert</th>
        <th>Verkauft</th>
        <th>Verkaufspreis</th>
        <th>Sprache</th>
        <th>Verkäufer</th>
        <th>Kaufdatum</th>
        <th>URL</th>
        <th>Angebote</th>
    </tr>
    <tr>
        <th class="id-column hidden"></th>
        <th>
            <input class="form-control form-control-sm"
                   name="setCode"
                   placeholder="Set Code"
                   th:value="${param.setCode}"
                   form="tableFilterForm"
                   onchange="document.getElementById('tableFilterForm').submit()">
        </th>
        <th></th>
        <th>
            <select class="form-select form-select-sm"
                    name="type"
                    form="tableFilterForm"
                    onchange="document.getElementById('tableFilterForm').submit()">
                <option value="">Typ wählen</option>
                <option th:each="t : ${types}"
                        th:value="${t}"
                        th:text="${t}"
                        th:selected="${param.type} == ${t}"></option>
            </select>
        </th>
        <th>
            <div class="form-check">
                <input class="form-check-input"
                       type="checkbox"
                       id="soldFilter"
                       form="tableFilterForm"
                       th:checked="${soldOnly}"
                       onchange="document.getElementById('soldOnly').value = this.checked ? 'true' : 'false'; document.getElementById('tableFilterForm').submit();">
                <label class="form-check-label" for="soldFilter">Verkauft</label>
            </div>
        </th>
        <th></th>
        <th></th>
        <th></th>
        <th></th>
        <th></th>
        <th></th>

        <th></th>
        <th></th>
        <th></th>
        <th></th>
        <th></th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="display,iter : ${displays}" class="clickable-row"
        th:attr="data-id=${display.id},
                 data-setcode=${display.setCode},
                 data-type=${display.type},
                 data-name=${display.name},
                 data-valuebought=${display.valueBought},
                 data-currentvalue=${display.currentValue},
                 data-location=${display.location},
                 data-updatedAt=${#temporals.format(display.updatedAt, 'yyyy-MM-dd HH:mm')},
                 data-sold=${display.sold},
                 data-soldprice=${display.soldPrice},
                 data-language=${display.language},
                 data-vendor=${display.vendor},
                 data-datebought=${#temporals.format(display.dateBought, 'yyyy-MM-dd')},
                 data-url=${display.url}">
        <td class="id-column hidden" th:text="${display.id}"></td>
        <td th:text="${display.setCode}"></td>
        <td>
            <img alt="Icon" style="width: 32px; height: 32px;"
                 th:src="${setCodeToIconUri[display.setCode] != null ? setCodeToIconUri[display.setCode] : ''}">
        </td>
        <td th:text="${display.type}"></td>
        <td th:text="${display.name}"></td>
        <td th:text="${display.valueBought}"></td>
 <td th:if="${display.currentValue != null}"
                th:text="${display.currentValue}"
                th:classappend="${display.currentValue > display.valueBought * 1.5} ? 'text-primary' : (${display.currentValue > display.valueBought} ? 'text-success' : '')">
            </td>
        <td th:if="${display.currentValue == null}">–</td>
        <td th:text="${display.location}"></td>
        <td th:text="${#temporals.format(display.updatedAt, 'yyyy-MM-dd')}"></td>
        <td th:text="${display.sold}"></td>
        <td th:text="${display.soldPrice}"></td>
        <td th:text="${display.language}"></td>
        <td th:text="${display.vendor}"></td>
        <td th:text="${#temporals.format(display.dateBought, 'yyyy-MM-dd')}"></td>
        <td th:if="${display.url != null}">
            <a th:href="${display.url}" th:text="${display.url}"></a>
        </td>
        <td th:if="${display.url == null}">–</td>
        <td>
            <ul>
                <li th:each="angebot, iterStat : ${display.angebotList}"
                    th:if="${iterStat.index} < 3"
                    th:text="${angebot.name + ' - ' + angebot.preis + ' €'}"></li>
            </ul>
        </td>
    </tr>
    </tbody>
</table>

<!-- Modal für Bearbeitung -->
<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog">
        <form action="/api/display/update" method="post" id="editForm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Display bearbeiten</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="id" id="modalId" />
                    <input type="hidden" name="setCode" id="modalSetCode" />
                    <input type="hidden" name="type" id="modalType" />
                    <input type="hidden" name="name" id="modalName" />
                    <input type="hidden" name="valueBought" id="modalValueBought" />
                    <input type="hidden" name="currentValue" id="modalCurrentValue" />
                    <input type="hidden" name="vendor" id="modalVendor" />
                    <input type="hidden" name="dateBought" id="modalDateBought" />
                    <input type="hidden" name="url" id="modalUrl" />
                    <div class="mb-3">
                        <label for="modalLocation" class="form-label">Lagerort</label>
                        <input type="text" class="form-control" name="location" id="modalLocation" />
                    </div>
                    <div class="mb-3">
                        <label for="modalSold" class="form-label">Verkauft</label>
                        <input type="checkbox" name="sold" id="modalSold" />
                    </div>
                    <div class="mb-3">
                        <label for="modalSoldPrice" class="form-label">Verkaufspreis</label>
                        <input type="number" class="form-control" name="soldPrice" id="modalSoldPrice" step="0.01" min="0" />
                    </div>
                    <div class="mb-3">
                        <label for="modalLanguage" class="form-label">Sprache</label>
                        <input type="text" class="form-control" name="language" id="modalLanguage" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-success">Speichern</button>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
    function toggleIdColumn() {
        const idColumns = document.querySelectorAll('.id-column');
        idColumns.forEach(column => {
            column.classList.toggle('hidden');
        });
    }

    function sortTable(columnIndex) {
        const table = document.getElementById("displayTable");
        const rows = Array.from(table.tBodies[0].rows);
        const isAscending = table.getAttribute("data-sort-order") === "asc";
        const direction = isAscending ? 1 : -1;

        rows.sort((a, b) => {
            const aText = a.cells[columnIndex].innerText.trim();
            const bText = b.cells[columnIndex].innerText.trim();
            return aText.localeCompare(bText) * direction;
        });

        rows.forEach(row => table.tBodies[0].appendChild(row));
        table.setAttribute("data-sort-order", isAscending ? "desc" : "asc");
    }

    document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('.clickable-row').forEach(function(row) {
            row.addEventListener('click', function() {
                document.getElementById('modalId').value = row.getAttribute('data-id');
                document.getElementById('modalSetCode').value = row.getAttribute('data-setcode');
                document.getElementById('modalType').value = row.getAttribute('data-type');
                document.getElementById('modalName').value = row.getAttribute('data-name');
                document.getElementById('modalValueBought').value = row.getAttribute('data-valuebought');
                document.getElementById('modalCurrentValue').value = row.getAttribute('data-currentvalue');
                document.getElementById('modalLocation').value = row.getAttribute('data-location');
                document.getElementById('modalSold').checked = row.getAttribute('data-sold') === 'true';
                document.getElementById('modalSoldPrice').value = row.getAttribute('data-soldprice') || '';
                document.getElementById('modalVendor').value = row.getAttribute('data-vendor');
                document.getElementById('modalDateBought').value = row.getAttribute('data-datebought');
                document.getElementById('modalUrl').value = row.getAttribute('data-url');
                document.getElementById('modalLanguage').value = row.getAttribute('data-language');
                new bootstrap.Modal(document.getElementById('editModal')).show();
            });
        });
    });
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>